# 小红书数据映射工具 v2.7 项目文档

**最后更新**: 2026-02-25
**当前版本**: v2.7

---

## 1. 核心功能

本工具是一个前端数据处理应用，旨在自动化处理来自小红书不同业务平台的数据报告，将其映射到一个统一的、标准化的数据模板中。它解决了手动复制粘贴数据时效率低下、易出错的问题，尤其是在处理具有复杂多级表头或不同数据格式的源文件时。

主要支持两种数据源：

1.  **小红书蒲公英 (Pugongying)**: 处理官方导出的、具有三级复杂表头的 Excel 文件 (`.xlsx`, `.xls`)。
2.  **小红书聚光 (Juguang)**: 处理广告后台导出的、单行表头的 CSV 文件 (`.csv`)。

核心任务是将这两种结构迥异、字段命名不一的数据源，精准地填充到一套包含 160+ 字段的标准化模板中，并输出为干净的 Excel 文件。

## 2. 算法与运行逻辑

工具的整个处理流程在浏览器前端完成，不依赖任何后端服务。核心算法围绕着**表头解析**、**字段映射**、**数据填充**和**结果验证**四个阶段展开。

### 2.1. 文件读取与预处理

- **统一格式**: 无论用户上传的是 Excel 文件还是 CSV 文件，工具底层都统一使用 [SheetJS (xlsx.js)](https://github.com/SheetJS/sheetjs) 库进行解析。
- **CSV 转 XLSX**: 为了简化处理逻辑，当检测到输入文件为 CSV 格式时，会先将其在内存中转换为与 Excel 文件相同的内部数据结构（Workbook Object），后续所有操作（如表头解析、数据提取）都走同一套流程。

### 2.2. 表头解析 (`parseSrcHeaders`)

此阶段的目标是创建一个从“字段唯一标识”到“列索引号”的映射表 (`srcColMap`)。

- **蒲公英 (多级表头)**: 蒲公英数据源的表头有三级。算法会遍历前三行，将每一列的三个表头文本用 `|` 符号拼接起来，形成一个唯一的键（例如 `跨域项目数据|淘宝合作效果|任务开始时间`），并记录其对应的列索引。
- **聚光 (单行表头)**: 聚光数据源为单行表头，直接使用第一行的字段名作为键，记录其列索引。

### 2.3. 字段映射 (`startMapping` 主流程)

映射的核心是 `MAPPING_CONFIG` 配置对象，它定义了模板中每一列应该从数据源的哪个字段获取数据。

- **索引构建**: 算法遍历 `MAPPING_CONFIG`，根据当前选择的数据类型（蒲公英/聚光），使用预设的源字段名或拼接键在 `srcColMap` 中查找对应的列索引。查找到的结果存入 `colIndexMap`，其结构为 `{ 模板列索引: 源文件列索引 }`。
- **状态追踪**: 对于模板中的每个字段，会标记其映射状态：`mapped` (已映射), `blank` (公式字段，需留白), 或 `not_found` (源文件中未找到)。

### 2.4. 数据填充 (`fillTemplate`)

- **行遍历**: 逐行读取解析出的源数据 (`srcRows`)。
- **列填充**: 对每一行，根据 `colIndexMap`，将源数据列的值精准地填充到新创建的模板行 (`tplRow`) 的相应位置。
- **日期格式化**: 在填充过程中，会进行关键的日期格式化操作。这是为了解决 Excel 中日期存储为序列号（如 `46061`）的问题。

### 2.5. 核心算法：时区无关的日期转换 (`serialToYMD`)

这是整个工具最关键的算法之一，用于确保在任何用户的电脑和时区设置下，日期都能被正确解析。

- **问题**: JavaScript 的 `new Date()` 在解析 Excel 序列号时会受到本地时区的影响，导致结果可能出现一天偏差。
- **解决方案**: `serialToYMD` 函数采用纯数学方法，不依赖本地时区。
    1.  它以 `1900-01-01` 作为序列号 `1` 的基准，但使用 `Date.UTC(1900, 0, 0)` (即 1899-12-31) 作为计算起点。
    2.  通过 `基准UTC毫秒数 + (序列号 * 每天的毫秒数)` 计算出目标日期的 UTC 毫秒表示。
    3.  用 `new Date(ms)` 创建日期对象，并使用 `getUTCFullYear()`, `getUTCMonth()`, `getUTCDate()` 来提取年、月、日。
    4.  因为整个过程都在 UTC 下完成，所以完全消除了时区带来的不确定性。
- **触发条件**: 在 `fillTemplate` 函数中，仅当一个字段的模板名 `tplName` 包含“**日期**”二字，并且其值是一个大于 1000 的数字（Excel 序列号的典型特征）时，才会调用 `serialToYMD` 进行转换。

### 2.6. 数据验证 (`verifyData`)

为了确保映射的准确性，工具包含一个验证阶段。

- **原始数据副本**: 在提取数据后，会立刻创建一个未经任何修改的深拷贝 `rawSrcRows`。
- **逐格比对**: 在数据填充完成后，算法会逐行逐单元格地比对 `rawSrcRows`（原始值）和 `resultRows`（填充后的值）。
- **智能日期比对 (`normalizeValForVerify`)**: 直接比对原始值和填充值是行不通的（例如，原始值是序列号 `46061`，填充值是字符串 `2026-02-08`）。因此，在比对前，`normalizeValForVerify` 函数会先把两边的值都统一为标准格式：
    - **日期字段**: 无论是序列号、`m/d/yyyy` 还是 `yyyy-mm-dd` 格式，都统一转换成 `YYYY-MM-DD` 字符串再进行比较。
    - **非日期字段**: 直接作为字符串进行比较。
- **错误报告**: 任何不匹配的单元格都会被记录下来，并在“数据验证”选项卡中高亮展示，方便用户排查。

## 3. 源代码逻辑

整个工具由一个独立的 HTML 文件构成，内嵌 CSS 和 JavaScript，无外部框架依赖，便于分发和使用。

- **`index.html`**: 主文件。
    - **CSS**: 负责所有 UI 样式，采用 BEM 风格的 class 命名，并使用 CSS 变量定义设计系统（颜色、圆角、阴影等）。
    - **HTML**: 定义了页面结构，包括文件上传区、类型选择、进度日志、结果展示等模块。
    - **JavaScript**: 包含所有核心逻辑。
        - **`MAPPING_CONFIG` (全局常量)**: 核心映射配置表，以 JSON 格式定义了蒲公英和聚光两种数据类型的字段映射规则。**是修改和维护映射关系的主要入口。**
        - **`state` (全局对象)**: 存储当前会话的状态，如选择的数据类型、解析后的工作簿对象、处理结果、验证错误等。
        - **UI 控制函数**: 如 `showTab`, `log`, `updateProgress` 等，负责界面交互和反馈。
        - **核心处理函数**: `startMapping` 是主入口，依次调用 `parseSrcHeaders`, `extractDataRows`, `fillTemplate`, `verifyData` 等辅助函数，形成一个清晰的处理管道。
        - **工具函数**: 如 `serialToYMD`, `validateJuguangDate`, `normalizeValForVerify`，提供日期处理、验证等专项能力。

## 4. 输入与输出

- **输入**: 
    - **蒲公英**: `.xlsx` 或 `.xls` 文件，必须包含三级表头。
    - **聚光**: `.csv` 文件，必须为单行表头，且第一列为单日日期。
- **输出**: 
    - **文件名**: `匹配成功_[蒲公英/聚光广告]_[时间戳].xlsx`
    - **内容**: 单个工作表（Sheet），表头为标准模板的字段名，内容为从源文件填充的数据。

## 5. 使用方法

1.  打开 `小红书数据映射工具v2.7.html` 文件。
2.  **选择类型**: 在“第一步”卡片中，点击选择“蒲公英数据”或“聚光广告”。
3.  **上传文件**: 将对应的数据源文件拖拽到上传区域，或点击上传。
4.  **开始匹配**: 文件信息显示后，点击“🚀 开始匹配”按钮。
5.  **查看日志**: “执行日志”选项卡会实时显示处理进度和每一步的结果。
6.  **验证结果**: 匹配完成后，可切换到“数据验证”选项卡查看是否有不一致的数据。绿色表示通过，红色表示异常。
7.  **下载文件**: 在右侧“处理完成”卡片中，点击“⬇️ 下载结果文件”按钮即可保存映射好的 Excel 文件。

## 6. 主要版本历史 (v2.0 - v2.7)

| 版本 | 主要更新内容 |
| :--- | :--- |
| **v2.7** | - **日期算法修复**: 彻底修复了因时区问题导致的日期偏差1天的问题，改用纯数学算法 `serialToYMD`，确保在任何时区下日期都正确。<br>- **CSV 流程统一**: CSV 文件先在内存中转为 xlsx 格式再处理，统一了后续所有逻辑。<br>- **验证逻辑增强**: 验证阶段使用原始数据副本进行比对，并对日期字段进行标准化处理后再比较，确保验证的绝对准确性。<br>- **UI 优化**: 统一了各选项卡的高度，增加了页脚和“回到顶部”按钮。 |
| **v2.6** | - 修复了 Excel 日期序列号在特定时区下的解析问题。<br>- 统一了各选项卡内容区的高度，优化了 UI 布局。 |
| **v2.5** | - 修复了切换数据类型后下载文件表头不更新的 bug。<br>- 修复了聚光模式下“数据源独有字段”卡片被隐藏的问题。 |
| **v2.4** | - 增强了日期识别逻辑，支持带小数的序列号和带时间的日期字符串。 |
| **v2.3** | - **UI 重大改版**: 增加了可点击的版本号徽章、更新日志弹窗、动态统计卡片。<br>- 将“数据源独有字段”移出主表，独立为卡片，使主映射表更整洁。 |
| **v2.2** | - **输出规范化**: 统一输出文件格式为 `.xlsx`，并规范了文件名和工作表名称。 |
| **v2.1** | - **聚光日期验证**: 新增了对聚光数据源的日期验证，拒绝时间段格式的数据。<br>- 修复了日期列输出为序列号的问题。 |
| **v2.0** | - **新增聚光支持**: 首次加入了对“聚光广告”数据类型的支持，包括 CSV 文件解析和 76 个字段的映射。 |
